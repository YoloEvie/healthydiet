import{_ as X,u as Y,a as Z}from"./index-bPO5O26h.js";import{a as ee}from"./axios-NIGUFBhG.js";import{r as I,b as te,v as se,k as m,e as y,o as g,f as k,g as n,j as a,l as f,F as U,A as h,y as ne,u as V,S as B,P as O,z as re,H as o}from"./element-plus-BAXMo5c4.js";const ae={class:"article-container"},le={class:"header"},oe={class:"ingredients-list"},ie={class:"steps-list"},ue={class:"step-number"},de={__name:"EditArticle",setup(pe){const A=ee.create({baseURL:"http://localhost:3000",headers:{"Content-Type":"application/json"}}),v=Y(),C=Z().params.id,w=I(null),x=I([]),$=I(null),c=I(new Set),t=te({id:"",title:"",summary:"",recipeId:"",ingredients:[{name:"",amount:""}],steps:[{content:""}],tips:"",status:"draft",authorId:"",content:"{}",likesCount:0,createdAt:"",updatedAt:""}),S={title:[{required:!0,message:"请输入文章标题",trigger:"blur"},{max:100,message:"标题长度不能超过100个字符",trigger:"blur"}],summary:[{required:!0,message:"请输入文章摘要",trigger:"blur"}],recipeId:[{required:!0,message:"请选择所属食谱",trigger:"change"}]},i=s=>{c.value.add(s)},E=()=>{let s=localStorage.getItem("user_id");return s&&(s=s.replace(/^["']|["']$/g,"")),s},F=()=>E()?!0:(o.error("请先登录"),v.push("/login"),!1),J=async()=>{try{const s=E(),e=await A.get(`/api/recipes/user/${s}`);Array.isArray(e.data)?x.value=e.data:(console.error("食谱数据格式错误:",e.data),o.error("获取食谱数据失败"))}catch(s){console.error("获取食谱列表失败:",s),o.error("获取食谱列表失败，请重试")}},z=s=>{try{if(!s||s==="{}")return{ingredients:[{name:"",amount:""}],steps:[{content:""}],tips:""};const e=JSON.parse(s);return{ingredients:e.ingredients&&Array.isArray(e.ingredients)&&e.ingredients.length?e.ingredients:[{name:"",amount:""}],steps:e.steps&&Array.isArray(e.steps)&&e.steps.length?e.steps:[{content:""}],tips:e.tips||""}}catch(e){return console.error("解析content数据失败:",e),{ingredients:[{name:"",amount:""}],steps:[{content:""}],tips:""}}},N=async()=>{if(!C){o.error("文章ID不存在"),v.back();return}try{const e=(await A.get(`/api/articles/${C}`)).data;$.value={...e};const{ingredients:l,steps:u,tips:d}=z(e.content);t.id=e.article_id||"",t.title=e.title||"",t.summary=e.summary||"",t.recipeId=e.recipe_id||"",t.authorId=e.author_id||"",t.content=e.content||"{}",t.likesCount=e.likes_count||0,t.status=e.status||"draft",t.createdAt=e.created_at||"",t.updatedAt=e.updated_at||"",t.ingredients=l,t.steps=u,t.tips=d,c.value.clear()}catch(s){console.error("获取文章详情失败:",s),o.error("加载文章失败，请重试"),v.back()}},j=()=>{t.ingredients.push({name:"",amount:""}),i("ingredients")},q=s=>{if(t.ingredients.length<=1){o.warning("至少保留一项食材");return}t.ingredients.splice(s,1),i("ingredients")},L=()=>{t.steps.push({content:""}),i("steps")},M=s=>{if(t.steps.length<=1){o.warning("至少保留一个步骤");return}t.steps.splice(s,1),i("steps")},T=async()=>{if(F()){if(c.value.size===0){o.info("没有修改任何内容");return}if(w.value){try{const s=Array.from(c.value).filter(e=>Object.keys(S).includes(e));s.length>0&&await w.value.validateField(s)}catch{return}if(c.value.has("ingredients")&&t.ingredients.some(e=>!e.name.trim()||!e.amount.trim())){o.error("请完善所有食材信息");return}if(c.value.has("steps")&&t.steps.some(e=>!e.content.trim())){o.error("请完善所有步骤信息");return}try{const s={};c.value.forEach(e=>{switch(e){case"title":s.title=t.title;break;case"summary":s.summary=t.summary;break;case"recipeId":s.recipe_id=t.recipeId;break;case"ingredients":case"steps":case"tips":const l=JSON.parse(t.content||"{}");e==="ingredients"&&(l.ingredients=t.ingredients),e==="steps"&&(l.steps=t.steps),e==="tips"&&(l.tips=t.tips),s.ingredients=JSON.stringify(l.ingredients),s.steps=JSON.stringify(l.steps),s.tips=l.tips;break;case"status":s.status=t.status;break}}),await A.put(`/api/articles/${C}`,s),o.success("文章更新成功"),await N(),v.push(`/cookbooks/view/${t.recipeId}`)}catch(s){console.error("更新文章失败:",s),o.error("更新文章失败，请重试")}}}},P=async()=>{if($.value){const s=$.value,{ingredients:e,steps:l,tips:u}=z(s.content);t.title=s.title||"",t.summary=s.summary||"",t.recipeId=s.recipe_id||"",t.status=s.status||"draft",t.content=s.content||"{}",t.ingredients=e,t.steps=l,t.tips=u,c.value.clear(),o.info("已恢复到原始数据")}},R=()=>{v.back()};return se(()=>{F()&&(J(),N())}),(s,e)=>{const l=m("el-button"),u=m("el-input"),d=m("el-form-item"),H=m("el-option"),G=m("el-select"),b=m("el-icon"),D=m("el-radio"),K=m("el-radio-group"),Q=m("el-form"),W=m("el-card");return g(),y("div",ae,[k("div",le,[n(l,{type:"primary",size:"small",onClick:R},{default:a(()=>e[13]||(e[13]=[f("返回")])),_:1,__:[13]}),e[14]||(e[14]=k("h2",null,"新增文章",-1))]),n(W,{class:"article-form-card",style:{"margin-top":"20px"}},{default:a(()=>[n(Q,{ref_key:"articleFormRef",ref:w,model:t,rules:S,"label-width":"100px"},{default:a(()=>[n(d,{label:"文章标题",prop:"title"},{default:a(()=>[n(u,{modelValue:t.title,"onUpdate:modelValue":e[0]||(e[0]=r=>t.title=r),placeholder:"请输入文章标题",maxlength:"100",onInput:e[1]||(e[1]=r=>i("title"))},null,8,["modelValue"])]),_:1}),n(d,{label:"所属食谱",prop:"recipeId"},{default:a(()=>[n(G,{modelValue:t.recipeId,"onUpdate:modelValue":e[2]||(e[2]=r=>t.recipeId=r),placeholder:"请选择食谱",clearable:"",onChange:e[3]||(e[3]=r=>i("recipeId"))},{default:a(()=>[(g(!0),y(U,null,h(x.value,r=>(g(),ne(H,{key:r.recipe_id,label:r.recipe_name,value:r.recipe_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),n(d,{label:"文章摘要",prop:"summary"},{default:a(()=>[n(u,{modelValue:t.summary,"onUpdate:modelValue":e[4]||(e[4]=r=>t.summary=r),placeholder:"请输入文章摘要",type:"textarea",rows:"3",onInput:e[5]||(e[5]=r=>i("summary"))},null,8,["modelValue"])]),_:1}),n(d,{label:"食材列表"},{default:a(()=>[k("div",oe,[(g(!0),y(U,null,h(t.ingredients,(r,_)=>(g(),y("div",{key:_,class:"ingredient-item"},[n(u,{modelValue:r.name,"onUpdate:modelValue":p=>r.name=p,placeholder:"食材名称",class:"ingredient-name",onInput:e[6]||(e[6]=p=>i("ingredients"))},null,8,["modelValue","onUpdate:modelValue"]),n(u,{modelValue:r.amount,"onUpdate:modelValue":p=>r.amount=p,placeholder:"用量",class:"ingredient-amount",onInput:e[7]||(e[7]=p=>i("ingredients"))},null,8,["modelValue","onUpdate:modelValue"]),n(l,{type:"danger",size:"small",onClick:p=>q(_)},{default:a(()=>[n(b,null,{default:a(()=>[n(V(B))]),_:1})]),_:2},1032,["onClick"])]))),128)),n(l,{type:"primary",size:"small",onClick:j},{default:a(()=>[n(b,null,{default:a(()=>[n(V(O))]),_:1}),e[15]||(e[15]=f(" 添加食材 "))]),_:1,__:[15]})])]),_:1}),n(d,{label:"制作步骤"},{default:a(()=>[k("div",ie,[(g(!0),y(U,null,h(t.steps,(r,_)=>(g(),y("div",{key:_,class:"step-item"},[k("div",ue,re(_+1),1),n(u,{modelValue:r.content,"onUpdate:modelValue":p=>r.content=p,placeholder:"请输入步骤内容",type:"textarea",rows:"2",class:"step-content",onInput:e[8]||(e[8]=p=>i("steps"))},null,8,["modelValue","onUpdate:modelValue"]),n(l,{type:"danger",size:"small",onClick:p=>M(_)},{default:a(()=>[n(b,null,{default:a(()=>[n(V(B))]),_:1})]),_:2},1032,["onClick"])]))),128)),n(l,{type:"primary",icon:"Plus",size:"small",onClick:L},{default:a(()=>[n(b,null,{default:a(()=>[n(V(O))]),_:1}),e[16]||(e[16]=f(" 添加步骤 "))]),_:1,__:[16]})])]),_:1}),n(d,{label:"烹饪小贴士"},{default:a(()=>[n(u,{modelValue:t.tips,"onUpdate:modelValue":e[9]||(e[9]=r=>t.tips=r),placeholder:"请输入烹饪小贴士",type:"textarea",rows:"3",onInput:e[10]||(e[10]=r=>i("tips"))},null,8,["modelValue"])]),_:1}),n(d,{label:"发布状态"},{default:a(()=>[n(K,{modelValue:t.status,"onUpdate:modelValue":e[11]||(e[11]=r=>t.status=r),onChange:e[12]||(e[12]=r=>i("status"))},{default:a(()=>[n(D,{label:"draft"},{default:a(()=>e[17]||(e[17]=[f("草稿")])),_:1,__:[17]}),n(D,{label:"published"},{default:a(()=>e[18]||(e[18]=[f("发布")])),_:1,__:[18]})]),_:1},8,["modelValue"])]),_:1}),n(d,null,{default:a(()=>[n(l,{type:"primary",onClick:T},{default:a(()=>e[19]||(e[19]=[f("保存修改")])),_:1,__:[19]}),n(l,{onClick:P},{default:a(()=>e[20]||(e[20]=[f("重置")])),_:1,__:[20]}),n(l,{onClick:R},{default:a(()=>e[21]||(e[21]=[f("取消")])),_:1,__:[21]})]),_:1})]),_:1},8,["model"])]),_:1})])}}},_e=X(de,[["__scopeId","data-v-cdfeac9d"]]);export{_e as default};
