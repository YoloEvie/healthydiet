import{a as F}from"./axios-NIGUFBhG.js";import{_ as j,u as z}from"./index-DAIr6xV4.js";import{r as v,k as p,x,o as g,j as o,g as t,f as D,e as U,G as _,b as L,t as K,l as y,v as S,y as W,M as H}from"./element-plus-DirRqt2a.js";const Q=["src"],X={__name:"UploadAvatar",emits:["avatar-updated"],setup(N,{emit:I}){const w=v({}),C=async c=>{try{const r=new FormData;r.append("cover",c.raw);const n=await F.post("http://localhost:3000/api/upload/cover",r,{headers:{"Content-Type":"multipart/form-data"}});n.data.url&&(w.value.avatar=n.data.url,V("avatar-updated",n.data.url))}catch(r){console.error("头像上传失败:",r),_.error("头像上传失败，请重试")}},P=c=>{const r=c.type==="image/jpeg"||c.type==="image/png",n=c.size/1024/1024<2;return r||_.error("上传头像图片只能是 JPG/PNG 格式!"),n||_.error("上传头像图片大小不能超过 2MB!"),r&&n},V=I;return(c,r)=>{const n=p("UserFilled"),b=p("el-icon"),a=p("el-upload"),k=p("el-form-item");return g(),x(k,{label:"用户头像",prop:"avatar"},{default:o(()=>[t(a,{class:"avatar-uploader",action:"","show-file-list":!1,"on-change":C,"before-upload":P},{default:o(()=>[w.value.avatar?(g(),U("img",{key:0,src:w.value.avatar,class:"avatar"},null,8,Q)):(g(),x(b,{key:1,class:"avatar-uploader-icon"},{default:o(()=>[t(n)]),_:1}))]),_:1}),r[0]||(r[0]=D("div",{class:"form-hint"},"支持JPG、PNG格式，大小不超过2MB",-1))]),_:1,__:[0]})}}},Z=j(X,[["__scopeId","data-v-2e1b008d"]]),ee={class:"profile-edit-container"},ae={key:0,class:"loading-container"},te={key:1,class:"error-container"},re={__name:"PersonalSet",setup(N){const I=z(),w=v(null),C=v({}),P=v(!0),V=v(!1),c=v(""),r=v(!1),n=v(!1),b=v({}),a=L({id:"",avatar:"",username:"",gender:"",birthDate:"",oldPassword:"",newPassword:"",confirmPassword:""}),k={username:[{message:"请输入用户名",trigger:"blur"},{min:2,max:20,message:"用户名长度在2-20个字符之间",trigger:"blur"}],birthDate:[{validator:(s,e,l)=>{if(!e){l();return}if(!/^\d{4}-\d{2}-\d{2}$/.test(e)){l(new Error("请严格按照YYYY-MM-DD格式输入（例如：1990-01-01）"));return}const d=e.split("-"),u=parseInt(d[0],10),m=parseInt(d[1],10)-1,M=parseInt(d[2],10),Y=new Date(u,m,M);if(Y.getFullYear()!==u||Y.getMonth()!==m||Y.getDate()!==M||u<1900||u>new Date().getFullYear()){l(new Error("请输入有效的日期"));return}l()},trigger:"blur"}],oldPassword:[{required:!0,message:"请输入原密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,max:20,message:"密码长度在6-20个字符之间",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(s,e,l)=>{e!==a.newPassword?l(new Error("两次输入的密码不一致")):l()},trigger:"blur"}]},$=()=>{const s=localStorage.getItem("user_id");return s?s.replace(/^"/,"").replace(/"$/,""):null},E=s=>{let e=s.replace(/\D/g,"");e.length>4&&(e=e.slice(0,4)+"-"+e.slice(4)),e.length>7&&(e=e.slice(0,7)+"-"+e.slice(7,10)),e.length>10&&(e=e.slice(0,10)),e!==s&&(a.birthDate=e),h()},O=()=>{const s=a.birthDate;if(!s)return;/^\d{4}-\d{2}-\d{2}$/.test(s)||_.warning("请严格按照YYYY-MM-DD格式输入日期（例如：1990-01-01）")},R=async()=>{const s=$();if(P.value=!0,c.value="",!s){c.value="未找到用户信息，请先登录",P.value=!1;return}try{const e=await F.get(`http://localhost:3000/api/users/${s}`);C.value=e.data;const{phone:l,...i}=e.data;if(Object.assign(a,i),i.birth_date){const d=new Date(i.birth_date);isNaN(d.getTime())||(a.birthDate=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`)}b.value={...a},n.value=!1}catch(e){console.error("获取用户信息失败:",e),c.value="获取用户信息失败，请稍后重试"}finally{P.value=!1}},h=()=>{const s=Object.keys(a).some(e=>r.value===!1&&["oldPassword","newPassword","confirmPassword"].includes(e)?!1:a[e]!==b.value[e]);n.value=s},A=s=>{a.avatar=s,h()},B=()=>{r.value=!r.value,r.value||(a.oldPassword="",a.newPassword="",a.confirmPassword=""),h()},G=async()=>{if(!(!w.value||!await w.value.validate())){V.value=!0;try{const e=$();if(!e){_.error("未找到用户信息");return}const l={};if(Object.keys(a).forEach(i=>{if(!["oldPassword","newPassword","confirmPassword","id"].includes(i)&&a[i]!==b.value[i]){const u={birthDate:"birth_date",avatar:"avatar_url",username:"username",gender:"gender"}[i];u&&(l[u]=a[i])}}),r.value&&a.newPassword)if((await F.post("http://localhost:3000/api/users/login",{phone_number:C.value.phone_number,password:a.oldPassword})).data.user)l.password_hash=a.newPassword;else{_.error("原密码验证失败");return}Object.keys(l).length>0?(await F.put(`http://localhost:3000/api/users/${e}`,l),_.success("信息更新成功"),I.push("/mine"),Object.assign(b.value,a),n.value=!1,r.value&&B()):_.info("没有需要更新的内容")}catch(e){console.error("更新失败:",e),_.error(e.response?.data?.message||"更新信息失败")}finally{V.value=!1}}},T=()=>{H.confirm("确定要取消修改吗？所有未保存的更改将会丢失。","确认取消",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{Object.assign(a,b.value),n.value=!1,r.value&&B(),w.value?.resetFields(),_.info("已取消修改"),I.push("/mine")}).catch(()=>{})};return K(()=>{R()}),(s,e)=>{const l=p("el-spinner"),i=p("el-alert"),d=p("el-button"),u=p("el-input"),m=p("el-form-item"),M=p("el-radio"),Y=p("el-radio-group"),q=p("el-form"),J=p("el-card");return g(),U("div",ee,[P.value?(g(),U("div",ae,[t(l,{size:"50"}),e[6]||(e[6]=D("p",null,"加载用户信息中...",-1))])):c.value?(g(),U("div",te,[t(i,{title:"错误提示",description:c.value,type:"error","show-icon":""},null,8,["description"]),t(d,{type:"primary",onClick:R},{default:o(()=>e[7]||(e[7]=[y("重新加载")])),_:1,__:[7]})])):(g(),x(J,{key:2,class:"profile-edit-card",style:{"max-width":"600px"}},{default:o(()=>[e[14]||(e[14]=D("div",{slot:"header",class:"card-header"},[D("h3",null,"修改用户信息")],-1)),t(q,{ref_key:"editFormRef",ref:w,model:a,rules:k,"label-width":"120px",class:"edit-form"},{default:o(()=>[t(Z,{onAvatarUpdated:A}),t(m,{label:"用户名称",prop:"username"},{default:o(()=>[t(u,{modelValue:a.username,"onUpdate:modelValue":e[0]||(e[0]=f=>a.username=f),placeholder:"请输入用户名",onInput:h},null,8,["modelValue"])]),_:1}),t(m,{label:"用户性别",prop:"gender"},{default:o(()=>[t(Y,{modelValue:a.gender,"onUpdate:modelValue":e[1]||(e[1]=f=>a.gender=f),onChange:h},{default:o(()=>[t(M,{label:"male"},{default:o(()=>e[8]||(e[8]=[y("男")])),_:1,__:[8]}),t(M,{label:"female"},{default:o(()=>e[9]||(e[9]=[y("女")])),_:1,__:[9]})]),_:1},8,["modelValue"])]),_:1}),t(m,{label:"出生日期",prop:"birthDate"},{default:o(()=>[t(u,{modelValue:a.birthDate,"onUpdate:modelValue":e[2]||(e[2]=f=>a.birthDate=f),placeholder:"请输入出生日期，格式为YYYY-MM-DD（选填）",onInput:E,onBlur:O,maxlength:"10"},null,8,["modelValue"]),e[10]||(e[10]=D("div",{class:"form-hint"}," 请严格按照YYYY-MM-DD格式输入，例如：1990-01-01 ",-1))]),_:1,__:[10]}),r.value?(g(),x(m,{key:0,label:"原密码",prop:"oldPassword"},{default:o(()=>[t(u,{type:"password",modelValue:a.oldPassword,"onUpdate:modelValue":e[3]||(e[3]=f=>a.oldPassword=f),placeholder:"请输入原密码",onInput:h},null,8,["modelValue"])]),_:1})):S("",!0),r.value?(g(),x(m,{key:1,label:"新密码",prop:"newPassword"},{default:o(()=>[t(u,{type:"password",modelValue:a.newPassword,"onUpdate:modelValue":e[4]||(e[4]=f=>a.newPassword=f),placeholder:"请设置新密码",onInput:h},null,8,["modelValue"]),e[11]||(e[11]=D("div",{class:"form-hint"},"密码长度在6-20个字符之间",-1))]),_:1,__:[11]})):S("",!0),r.value?(g(),x(m,{key:2,label:"确认新密码",prop:"confirmPassword"},{default:o(()=>[t(u,{type:"password",modelValue:a.confirmPassword,"onUpdate:modelValue":e[5]||(e[5]=f=>a.confirmPassword=f),placeholder:"请再次输入新密码",onInput:h},null,8,["modelValue"])]),_:1})):S("",!0),t(m,null,{default:o(()=>[t(d,{type:"text",onClick:B},{default:o(()=>[y(W(r.value?"取消修改密码":"修改密码"),1)]),_:1})]),_:1}),t(m,null,{default:o(()=>[t(d,{type:"primary",loading:V.value,onClick:G,disabled:!n.value},{default:o(()=>e[12]||(e[12]=[y(" 保存修改 ")])),_:1,__:[12]},8,["loading","disabled"]),t(d,{onClick:T,style:{"margin-left":"10px"}},{default:o(()=>e[13]||(e[13]=[y(" 取消 ")])),_:1,__:[13]})]),_:1})]),_:1},8,["model"])]),_:1,__:[14]}))])}}},ne=j(re,[["__scopeId","data-v-5dd160ff"]]);export{ne as default};
