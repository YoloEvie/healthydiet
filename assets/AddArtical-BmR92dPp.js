import{_ as Y,u as _e}from"./index-CMQRH6kX.js";import{c as K,r as v,k as c,e as g,o as u,g as l,j as a,u as A,O as Q,f as $,y as ee,G as i,b as ge,t as ve,l as b,v as _,x as k,F as M,z as H,R as W,M as X,Q as ye}from"./element-plus-DirRqt2a.js";import{a as E}from"./axios-NIGUFBhG.js";const he={class:"image-uploader"},be={class:"el-upload__tip text-sm text-gray-500"},ke=["src"],Ie={__name:"UpdatePicture",props:{articleId:{type:String,required:!0},maxCount:{type:Number,default:10},initialImages:{type:Array,default:()=>[]},uploadApi:{type:String,default:"http://localhost:3000/api/article-photos/article"},headers:{type:Object,default:()=>({})}},emits:["uploadSuccess","uploadError","update:fileList"],setup(B,{emit:V}){const d=B,I=V,z=K(()=>d.uploadApi),P=K(()=>({...d.headers})),f=v([]);d.initialImages.length>0&&(f.value=d.initialImages.map(o=>({url:o.image_url,uid:o.photo_id,name:o.photo_id,status:"success"})));const e=v(!1),p=v(""),w=(o,m)=>{i.warning(`最多只能上传${d.maxCount}张图片`)},T=o=>o.type==="image/jpeg"||o.type==="image/png"?o.size/1024/1024<5?!0:(i.error("图片大小不能超过5MB"),!1):(i.error("只能上传JPG/PNG格式的图片"),!1),J=(o,m,C)=>{o.length&&(i.success(`成功上传${o.length}张图片`),f.value=C,I("uploadSuccess",o),I("update:fileList",o))},j=o=>{i.error("上传失败，请稍后重试"),I("uploadError",o)},R=o=>{p.value=o.url,e.value=!0},L=async o=>{if(o.uid&&o.status==="success")try{i.success("图片已删除"),f.value=f.value.filter(m=>m.uid!==o.uid),I("update:fileList",f.value)}catch{i.error("删除失败，请稍后重试")}else f.value=f.value.filter(m=>m.uid!==o.uid)};return(o,m)=>{const C=c("el-icon"),q=c("el-upload"),O=c("el-dialog");return u(),g("div",he,[l(q,{class:"upload-demo",action:z.value,headers:P.value,multiple:!0,limit:B.maxCount,"on-exceed":w,"on-success":J,"on-error":j,"before-upload":T,"file-list":f.value,"list-type":"picture-card","on-preview":R,"on-remove":L,name:"file"},{tip:a(()=>[$("div",be," 支持上传jpg、png、jpeg格式，单张不超过5MB，最多上传"+ee(B.maxCount)+"张 ",1)]),default:a(()=>[l(C,null,{default:a(()=>[l(A(Q))]),_:1})]),_:1},8,["action","headers","limit","file-list"]),l(O,{modelValue:e.value,"onUpdate:modelValue":m[0]||(m[0]=F=>e.value=F),title:"图片预览",width:800},{default:a(()=>[$("img",{src:p.value,alt:"预览图",class:"preview-img",style:{width:"100%"}},null,8,ke)]),_:1},8,["modelValue"])])}}},Ve=Y(Ie,[["__scopeId","data-v-ba2fa4b7"]]),we={class:"article-container"},xe={class:"header"},Ue={key:0},$e={key:1},Re={class:"ingredients-list"},Ce={class:"steps-list"},Se={class:"step-number"},Ee={key:2},Ae={__name:"AddArtical",setup(B){E.defaults.baseURL="http://localhost:3000";const V=_e(),d=v(0),I=v(null),z=v(null),P=v(null),f=v([]),e=ge({title:"",description:"",type:"Ordinary",recipeId:"",ingredients:[{name:"",amount:""}],steps:[{content:""}],tips:"",content:"",status:"draft"}),p=v(""),w=v([]),T=v(localStorage.getItem("token")||""),J={title:[{required:!0,message:"请输入文章标题",trigger:"blur"},{max:100,message:"标题长度不能超过100个字符",trigger:"blur"}],description:[{required:!0,message:"请输入文章摘要",trigger:"blur"}],type:[{required:!0,message:"请选择文章类型",trigger:"change"}],recipeId:[{required:()=>e.type==="Recipe",message:"请选择所属食谱",trigger:"change"}]},j=r=>{r==="Ordinary"?e.recipeId="":e.content=""},R=()=>{let r=localStorage.getItem("user_id");return r?r.replace(/^["']|["']$/g,""):null},L=()=>R()?!0:(i.error("请先登录"),V.push("/login"),!1),o=async()=>{try{const r=R(),t=await E.get(`/api/recipes/user/${r}`);f.value=t.data}catch(r){console.error("获取食谱列表失败:",r),i.error("获取食谱列表失败，请重试")}},m=r=>{if(!r)return!1;const t="http://localhost:3000/api/article-photos/article",s=`${t}/${r}`;return new RegExp(`^${t}/[a-zA-Z0-9-]+$`).test(s)},C=async()=>{if(d.value===0){if(!I.value)return;try{await I.value.validate(),d.value++}catch{return}}else if(d.value===1){if(e.type==="Recipe"){const r=e.ingredients.some(s=>!s.name.trim()||!s.amount.trim()),t=e.steps.some(s=>!s.content.trim());if(r){i.error("请完善所有食材信息");return}if(t){i.error("请完善所有步骤信息");return}}else if(!e.content.trim()){i.error("请输入文章内容");return}try{if(await O(),!p.value){const r="获取文章ID失败";console.error(r),X.confirm(`${r}，是否重试？`,"操作失败",{confirmButtonText:"重试",cancelButtonText:"取消",type:"error"}).then(async()=>{await O(),p.value&&m(p.value)&&d.value++});return}if(!m(p.value)){i.warning("图片上传路径格式异常，请稍后重试");return}d.value++}catch{i.error("保存失败，请重试")}}},q=()=>{d.value--},O=async()=>{if(!L())return;if(!e.title)throw i.error("请完善基本信息"),new Error("基本信息不完整");const r={title:e.title,description:e.description,type:e.type,status:"draft",author_id:R(),content:e.type==="Recipe"?JSON.stringify({ingredients:e.ingredients,steps:e.steps,tips:e.tips}):e.content};e.type==="Recipe"&&(r.recipe_id=e.recipeId,r.ingredients=e.ingredients,r.steps=e.steps,r.tips=e.tips);try{let t;if(p.value)t=await E.put(`/api/articles/${p.value}`,r);else{t=await E.post("/api/articles",r,{timeout:1e4});const s=["article_id","id","ArticleId","articleId"];let y=null;for(const N of s)if(t.data&&t.data[N]){y=t.data[N];break}if(y)p.value=y,console.log("成功获取文章ID:",p.value);else throw new Error(`未能从服务器响应中获取文章ID，响应结构: ${JSON.stringify(t.data)}`)}return i.success("已保存为草稿"),t.data}catch(t){console.error("保存草稿失败:",t);let s="保存失败，请重试";throw t.message.includes("未能从服务器获取文章ID")?s="服务器响应格式不正确，无法获取文章ID":t.code==="ECONNABORTED"?s="请求超时，请检查网络连接":t.response&&(s=`服务器错误: ${t.response.data?.message||t.response.statusText}`),i.error(s),t}},F=async r=>{if(!p.value){i.error("请先完成前面步骤");return}const t=ye.service({message:r==="published"?"发布中...":"保存中...",lock:!0});try{const s={title:e.title,description:e.description,type:e.type,status:r,author_id:R(),content:e.type==="Recipe"?JSON.stringify({ingredients:e.ingredients,steps:e.steps,tips:e.tips}):e.content};if(e.type==="Recipe"&&(s.recipe_id=e.recipeId,s.ingredients=e.ingredients,s.steps=e.steps,s.tips=e.tips),await E.put(`/api/articles/${p.value}`,s),w.value.length>0){const y=w.value[0].photo_id;await E.put(`/api/article-photos/article/${p.value}/cover/${y}`)}i.success(r==="published"?"文章发布成功":"保存为草稿成功"),V.push(`/forum/article/${p.value}`)}catch(s){console.error("提交失败:",s),console.error("响应数据:",s.response?.data),i.error(`操作失败: ${s.response?.data?.message||"服务器内部错误"}`)}finally{t.close()}},te=()=>{p.value?X.confirm("是否放弃当前编辑？已保存的草稿将保留","确认取消",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{V.back()}).catch(()=>{}):V.back()},le=()=>{e.ingredients.push({name:"",amount:""})},re=r=>{if(e.ingredients.length<=1){i.warning("至少保留一项食材");return}e.ingredients.splice(r,1)},ae=()=>{e.steps.push({content:""})},se=r=>{if(e.steps.length<=1){i.warning("至少保留一个步骤");return}e.steps.splice(r,1)},oe=r=>{console.log("上传成功",r),w.value=r,i.success("图片上传成功")},ne=r=>{console.error("上传失败",r),i.error("图片上传失败，请重试")},ie=r=>{w.value=r},ue=()=>{V.back()};return ve(()=>{L()&&o()}),(r,t)=>{const s=c("el-button"),y=c("el-step"),N=c("el-steps"),x=c("el-input"),h=c("el-form-item"),Z=c("el-radio"),de=c("el-radio-group"),pe=c("el-option"),ce=c("el-select"),G=c("el-form"),D=c("el-icon"),me=c("el-alert"),fe=c("el-card");return u(),g("div",we,[$("div",xe,[l(s,{type:"primary",size:"small",onClick:ue},{default:a(()=>t[8]||(t[8]=[b("返回")])),_:1,__:[8]}),t[9]||(t[9]=$("h2",null,"新增文章",-1))]),l(N,{active:d.value,"finish-status":"success",class:"steps-nav"},{default:a(()=>[l(y,{title:"基本信息"}),l(y,{title:"内容编辑"}),l(y,{title:"上传图片与发布"})]),_:1},8,["active"]),l(fe,{class:"article-form-card",style:{"margin-top":"20px"}},{default:a(()=>[d.value===0?(u(),g("div",Ue,[l(G,{ref_key:"step1FormRef",ref:I,model:e,rules:J,"label-width":"100px"},{default:a(()=>[l(h,{label:"文章标题",prop:"title"},{default:a(()=>[l(x,{modelValue:e.title,"onUpdate:modelValue":t[0]||(t[0]=n=>e.title=n),placeholder:"请输入文章标题",maxlength:"100"},null,8,["modelValue"])]),_:1}),l(h,{label:"文章类型",prop:"type"},{default:a(()=>[l(de,{modelValue:e.type,"onUpdate:modelValue":t[1]||(t[1]=n=>e.type=n),onChange:j},{default:a(()=>[l(Z,{label:"Ordinary"},{default:a(()=>t[10]||(t[10]=[b("普通文章")])),_:1,__:[10]}),l(Z,{label:"Recipe"},{default:a(()=>t[11]||(t[11]=[b("食谱文章")])),_:1,__:[11]})]),_:1},8,["modelValue"])]),_:1}),e.type==="Recipe"?(u(),k(h,{key:0,label:"所属食谱",prop:"recipeId"},{default:a(()=>[l(ce,{modelValue:e.recipeId,"onUpdate:modelValue":t[2]||(t[2]=n=>e.recipeId=n),placeholder:"请选择食谱",clearable:""},{default:a(()=>[(u(!0),g(M,null,H(f.value,n=>(u(),k(pe,{key:n.recipe_id,label:n.recipe_name,value:n.recipe_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):_("",!0),l(h,{label:"文章摘要",prop:"description"},{default:a(()=>[l(x,{modelValue:e.description,"onUpdate:modelValue":t[3]||(t[3]=n=>e.description=n),placeholder:"请输入文章摘要",type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])):_("",!0),d.value===1?(u(),g("div",$e,[l(G,{ref_key:"step2FormRef",ref:z,"label-width":"100px"},{default:a(()=>[e.type==="Recipe"?(u(),k(h,{key:0,label:"食材列表"},{default:a(()=>[$("div",Re,[(u(!0),g(M,null,H(e.ingredients,(n,S)=>(u(),g("div",{key:S,class:"ingredient-item"},[l(x,{modelValue:n.name,"onUpdate:modelValue":U=>n.name=U,placeholder:"食材名称",class:"ingredient-name"},null,8,["modelValue","onUpdate:modelValue"]),l(x,{modelValue:n.amount,"onUpdate:modelValue":U=>n.amount=U,placeholder:"用量",class:"ingredient-amount"},null,8,["modelValue","onUpdate:modelValue"]),l(s,{type:"info",size:"small",onClick:U=>re(S)},{default:a(()=>[l(D,null,{default:a(()=>[l(A(W))]),_:1})]),_:2},1032,["onClick"])]))),128)),l(s,{type:"primary",size:"small",onClick:le},{default:a(()=>[l(D,null,{default:a(()=>[l(A(Q))]),_:1}),t[12]||(t[12]=b(" 添加食材 "))]),_:1,__:[12]})])]),_:1})):_("",!0),e.type==="Ordinary"?(u(),k(h,{key:1,label:"文章内容"},{default:a(()=>[l(x,{modelValue:e.content,"onUpdate:modelValue":t[4]||(t[4]=n=>e.content=n),placeholder:"请输入文章内容",type:"textarea",rows:"10"},null,8,["modelValue"])]),_:1})):_("",!0),e.type==="Recipe"?(u(),k(h,{key:2,label:"制作步骤"},{default:a(()=>[$("div",Ce,[(u(!0),g(M,null,H(e.steps,(n,S)=>(u(),g("div",{key:S,class:"step-item"},[$("div",Se,ee(S+1),1),l(x,{modelValue:n.content,"onUpdate:modelValue":U=>n.content=U,placeholder:"请输入步骤内容",type:"textarea",rows:"2",class:"step-content"},null,8,["modelValue","onUpdate:modelValue"]),l(s,{type:"info",size:"small",onClick:U=>se(S)},{default:a(()=>[l(D,null,{default:a(()=>[l(A(W))]),_:1})]),_:2},1032,["onClick"])]))),128)),l(s,{type:"primary",size:"small",onClick:ae},{default:a(()=>[l(D,null,{default:a(()=>[l(A(Q))]),_:1}),t[13]||(t[13]=b(" 添加步骤 "))]),_:1,__:[13]})])]),_:1})):_("",!0),e.type==="Recipe"?(u(),k(h,{key:3,label:"烹饪小贴士"},{default:a(()=>[l(x,{modelValue:e.tips,"onUpdate:modelValue":t[5]||(t[5]=n=>e.tips=n),placeholder:"请输入烹饪小贴士",type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1})):_("",!0)]),_:1},512)])):_("",!0),d.value===2?(u(),g("div",Ee,[l(G,{ref_key:"step3FormRef",ref:P,"label-width":"100px"},{default:a(()=>[l(h,{label:"相关图片"},{default:a(()=>[p.value?(u(),k(Ve,{key:0,articleId:p.value,initialImages:w.value,headers:{Authorization:`Bearer ${T.value}`},uploadApi:`http://localhost:3000/api/article-photos/article/${p.value}/batch`,onUploadSuccess:oe,onUploadError:ne,"onUpdate:fileList":ie},null,8,["articleId","initialImages","headers","uploadApi"])):(u(),k(me,{key:1,title:"请先完成前两步并保存文章，才能上传图片",type:"warning",closable:!1}))]),_:1})]),_:1},512)])):_("",!0),l(h,{class:"step-actions"},{default:a(()=>[d.value>0?(u(),k(s,{key:0,onClick:q},{default:a(()=>t[14]||(t[14]=[b(" 上一步 ")])),_:1,__:[14]})):_("",!0),d.value<2?(u(),k(s,{key:1,type:"primary",onClick:C},{default:a(()=>t[15]||(t[15]=[b(" 下一步 ")])),_:1,__:[15]})):_("",!0),d.value===2?(u(),g(M,{key:2},[l(s,{onClick:te},{default:a(()=>t[16]||(t[16]=[b("取消")])),_:1,__:[16]}),l(s,{type:"primary",onClick:t[6]||(t[6]=n=>F("draft"))},{default:a(()=>t[17]||(t[17]=[b(" 保存为草稿 ")])),_:1,__:[17]}),l(s,{type:"success",onClick:t[7]||(t[7]=n=>F("published"))},{default:a(()=>t[18]||(t[18]=[b(" 发布文章 ")])),_:1,__:[18]})],64)):_("",!0)]),_:1})]),_:1})])}}},Fe=Y(Ae,[["__scopeId","data-v-18ed054e"]]);export{Fe as default};
