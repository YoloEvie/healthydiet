import{a as m}from"./axios-NIGUFBhG.js";import{_ as N,u as A}from"./index-DAIr6xV4.js";import{U as S}from"./UpdateCover-DmNIz_as.js";import{r as c,t as T,G as t,k as h,e as v,o as i,f as r,g as d,j as f,v as M,l as g,y as U,x as V,u as I,P as B,Q as C}from"./element-plus-DirRqt2a.js";const j={class:"container"},q={class:"form-footer"},F={key:0,class:"draft-notification"},G={key:0,class:"preview-content"},L={class:"preview-image"},P=["src"],Q={key:1},R={class:"preview-details"},z={class:"status-badge"},H={key:1,class:"empty-preview"},J={__name:"AddBook",setup(K){const y=A(),l=c(""),u=c(""),n=c(""),p=c(null),k=c(!1),w=c(!1),b=()=>(localStorage.getItem("user_id")||"").replace(/^["']|["']$/g,"");T(()=>{D()});const D=async()=>{const o=b();if(o)try{const e=await m.get("http://localhost:3000/api/recipes/drafts/latest",{params:{user_id:o}});if(e.data&&e.data.recipe_id){const s=e.data;p.value=s.recipe_id,l.value=s.recipe_name||"",u.value=s.description||"",n.value=s.cover_image_url||"",w.value=!0,t.info("已加载您的草稿")}}catch(e){console.log("没有找到草稿或加载草稿失败:",e)}},$=async()=>{if(!l.value){t.warning("请至少输入食谱名称再保存草稿");return}const o=b();if(!o){t.error("请先登录"),y.push("/login");return}const e=C.service({lock:!0,text:"正在保存草稿...",background:"rgba(0, 0, 0, 0.7)"});try{const s={recipe_name:l.value,description:u.value,created_by:o,status:"draft",cover_image_url:n.value||""};let a;p.value?a=await m.put(`http://localhost:3000/api/recipes/${p.value}`,s):a=await m.post("http://localhost:3000/api/recipes",s),p.value=a.data.recipe_id,w.value=!0,k.value=!0,t.success("草稿保存成功"),setTimeout(()=>{k.value=!1},3e3)}catch(s){console.error("保存草稿失败:",s),t.error("保存草稿失败，请稍后重试")}finally{e.close()}},E=async()=>{if(!l.value){t.error("请输入食谱名称");return}if(!u.value){t.error("请输入食谱简介");return}if(!n.value){t.error("请上传食谱封面");return}const o=b();if(!o){t.error("请先登录"),y.push("/login");return}const e=C.service({lock:!0,text:"正在创建食谱...",background:"rgba(0, 0, 0, 0.7)"});try{const s={recipe_name:l.value,description:u.value,created_by:o,status:"published",cover_image_url:n.value};let a;p.value?a=await m.put(`http://localhost:3000/api/recipes/${p.value}`,s):a=await m.post("http://localhost:3000/api/recipes",s),t.success("食谱创建成功！"),y.push(`/cookbooks/view/${a.data.recipe_id}`)}catch(s){console.error("创建食谱失败:",s),s.response?(console.error("响应状态:",s.response.status),console.error("响应数据:",s.response.data),s.response.status===500?t.error("服务器内部错误，请联系管理员或稍后重试"):s.response.status===400?t.error(s.response.data.message||"提交的数据格式不正确"):s.response.status===401?(t.error("您未登录或登录已过期，请重新登录"),y.push("/login")):t.error(`请求失败: ${s.response.status}`)):s.request?t.error("未收到服务器响应，请请检查网络连接"):t.error("请求准备过程中发生错误")}finally{e.close()}};return(o,e)=>{const s=h("el-input"),a=h("el-button"),x=h("el-card");return i(),v("div",j,[e[13]||(e[13]=r("header",null,[r("h1",null,"创建美味食谱"),r("p",null,"分享您的独家秘方，让更多人享受烹饪的乐趣")],-1)),d(x,{id:"upload"},{default:f(()=>[e[6]||(e[6]=r("h3",null,"上传食谱封面",-1)),d(S,{imageUrl:n.value,"onUpdate:imageUrl":e[0]||(e[0]=_=>n.value=_)},null,8,["imageUrl"]),e[7]||(e[7]=r("h3",null,"食谱名称",-1)),d(s,{modelValue:l.value,"onUpdate:modelValue":e[1]||(e[1]=_=>l.value=_),placeholder:"请输入食谱名称（例如：法式奶油蘑菇汤）"},null,8,["modelValue"]),e[8]||(e[8]=r("h3",null,"食谱简介",-1)),d(s,{modelValue:u.value,"onUpdate:modelValue":e[2]||(e[2]=_=>u.value=_),placeholder:"请输入食谱简介（例如：浓郁奶香与新鲜蘑菇的完美结合，简单易做的法式经典）",type:"textarea"},null,8,["modelValue"]),r("div",q,[d(a,{onClick:$},{default:f(()=>e[3]||(e[3]=[g("保存草稿")])),_:1,__:[3]}),d(a,{type:"primary",onClick:E},{default:f(()=>e[4]||(e[4]=[g("创建食谱")])),_:1,__:[4]})]),k.value?(i(),v("div",F,e[5]||(e[5]=[r("i",{class:"el-icon-success"},null,-1),g(" 草稿已保存 ")]))):M("",!0)]),_:1,__:[6,7,8]}),d(x,{class:"form-preview"},{default:f(()=>[e[12]||(e[12]=r("h2",null,"食谱预览",-1)),n.value||l.value||u.value?(i(),v("div",G,[r("div",L,[n.value?(i(),v("img",{key:0,src:n.value,alt:"食谱封面"},null,8,P)):(i(),v("span",Q,"暂无封面"))]),r("div",R,[r("h3",null,U(l.value||"未命名食谱"),1),r("p",null,U(u.value||"暂无食谱简介"),1),r("div",z,[w.value?(i(),V(I(B),{key:0,type:"info"},{default:f(()=>e[9]||(e[9]=[g("草稿")])),_:1,__:[9]})):(i(),V(I(B),{key:1,type:"success"},{default:f(()=>e[10]||(e[10]=[g("待发布")])),_:1,__:[10]}))])])])):(i(),v("div",H,e[11]||(e[11]=[r("p",null,"填写表单后，这里将显示您的食谱预览",-1)])))]),_:1,__:[12]})])}}},Z=N(J,[["__scopeId","data-v-9d215c10"]]);export{Z as default};
