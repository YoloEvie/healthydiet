import{a as k}from"./axios-NIGUFBhG.js";import{_ as D,u as E,a as $}from"./index-bPO5O26h.js";import{U as N}from"./UpdateCover-BvN9h4LX.js";import{r as g,v as R,k as y,e as v,o as m,f as r,g as l,j as p,l as f,z as w,H as s,R as b,N as M}from"./element-plus-BAXMo5c4.js";const T={class:"container"},S={class:"header"},j={class:"form-footer"},q={key:0,class:"preview-content"},z={class:"preview-image"},F=["src"],H={key:1},L={class:"preview-details"},A={key:1,class:"empty-preview"},G={class:"delete-section"},J={__name:"EditCookBook",setup(K){const a=E(),U=$(),u=g(""),c=g(""),n=g(""),_=g(""),C=()=>(localStorage.getItem("user_id")||"").replace(/^["']|["']$/g,""),I=async()=>{const t=U.params.id;if(!t){s.error("获取食谱ID失败");return}_.value=t;const e=b.service({lock:!0,text:"正在加载食谱信息...",background:"rgba(0, 0, 0, 0.7)"});try{const i=(await k.get(`http://localhost:3000/api/recipes/${t}`)).data;u.value=i.recipe_name,c.value=i.description,n.value=i.cover_image_url}catch(o){console.error("获取食谱详情失败:",o),s.error("加载食谱信息失败，请重试"),a.push("/cookbooks")}finally{e.close()}},h=()=>{a.push("/cookbooks")},V=async()=>{if(!u.value){s.error("请输入食谱名称");return}if(!c.value){s.error("请输入食谱简介");return}if(!n.value){s.error("请上传食谱封面");return}const t=C();if(!t){s.error("请先登录"),a.push("/login");return}const e=b.service({lock:!0,text:"正在更新食谱...",background:"rgba(0, 0, 0, 0.7)"});try{const o={recipe_name:u.value,description:c.value,created_by:t,status:"published",cover_image_url:n.value};console.log("发送到后端的更新数据:",o);const i=await k.put(`http://localhost:3000/api/recipes/${_.value}`,o);s.success("食谱更新成功！"),a.push(`/cookbooks/view/${i.data.recipe_id}`)}catch(o){console.error("更新食谱失败:",o),o.response?(console.error("响应状态:",o.response.status),console.error("响应数据:",o.response.data),o.response.status===500?s.error("服务器内部错误，请联系管理员或稍后重试"):o.response.status===400?s.error(o.response.data.message||"提交的数据格式不正确"):o.response.status===401?(s.error("您未登录或登录已过期，请重新登录"),a.push("/login")):o.response.status===404?(s.error("未找到该食谱"),a.push("/cookbooks")):s.error(`请求失败: ${o.response.status}`)):o.request?s.error("未收到服务器响应，请检查网络连接"):s.error("请求准备过程中发生错误")}finally{e.close()}},B=async()=>{if(!_.value){s.error("无法获取食谱ID，删除失败");return}try{if(await M.confirm("确定要删除这个食谱吗？此操作不可撤销。","删除确认",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",center:!0})==="confirm"){const e=b.service({lock:!0,text:"正在删除食谱...",background:"rgba(0, 0, 0, 0.7)"});try{await k.delete(`http://localhost:3000/api/recipes/${_.value}`),s.success("食谱已成功删除"),a.push("/cookbooks")}catch(o){console.error("删除食谱失败:",o),o.response&&o.response.status===403?s.error("您没有权限删除此食谱"):o.response&&o.response.status===404?(s.error("未找到该食谱"),a.push("/cookbooks")):s.error("删除失败，请稍后重试")}finally{e.close()}}}catch{s.info("已取消删除")}};return R(()=>{I()}),(t,e)=>{const o=y("el-button"),i=y("el-input"),x=y("el-card");return m(),v("div",T,[r("header",S,[l(o,{type:"success",onClick:h,class:"cancel-btn cancel-btn-header"},{default:p(()=>e[3]||(e[3]=[f(" 返回 ")])),_:1,__:[3]}),e[4]||(e[4]=r("div",{class:"header-text"},[r("h1",null,"编辑食谱"),r("p",null,"修改您的独家秘方，让更多人享受烹饪的乐趣")],-1))]),l(x,{id:"upload"},{default:p(()=>[e[7]||(e[7]=r("h3",null,"上传食谱封面",-1)),l(N,{imageUrl:n.value,"onUpdate:imageUrl":e[0]||(e[0]=d=>n.value=d)},null,8,["imageUrl"]),e[8]||(e[8]=r("h3",null,"食谱名称",-1)),l(i,{modelValue:u.value,"onUpdate:modelValue":e[1]||(e[1]=d=>u.value=d),placeholder:"请输入食谱名称（例如：法式奶油蘑菇汤）"},null,8,["modelValue"]),e[9]||(e[9]=r("h3",null,"食谱简介",-1)),l(i,{modelValue:c.value,"onUpdate:modelValue":e[2]||(e[2]=d=>c.value=d),placeholder:"请输入食谱简介（例如：浓郁奶香与新鲜蘑菇的完美结合，简单易做的法式经典）",type:"textarea"},null,8,["modelValue"]),r("div",j,[l(o,{type:"success",onClick:h,class:"cancel-btn"},{default:p(()=>e[5]||(e[5]=[f("取消")])),_:1,__:[5]}),l(o,{type:"primary",onClick:V},{default:p(()=>e[6]||(e[6]=[f("确定")])),_:1,__:[6]})])]),_:1,__:[7,8,9]}),l(x,{class:"form-preview"},{default:p(()=>[e[11]||(e[11]=r("h2",null,"食谱预览",-1)),n.value||u.value||c.value?(m(),v("div",q,[r("div",z,[n.value?(m(),v("img",{key:0,src:n.value,alt:"食谱封面"},null,8,F)):(m(),v("span",H,"暂无封面"))]),r("div",L,[r("h3",null,w(u.value||"未命名食谱"),1),r("p",null,w(c.value||"暂无食谱简介"),1)])])):(m(),v("div",A,e[10]||(e[10]=[r("p",null,"填写表单后，这里将显示您的食谱预览",-1)])))]),_:1,__:[11]}),r("div",G,[l(o,{type:"danger",onClick:B,class:"delete-btn",icon:"Delete"},{default:p(()=>e[12]||(e[12]=[f(" 删除此食谱 ")])),_:1,__:[12]}),e[13]||(e[13]=r("p",{class:"delete-warning"},[r("i",{class:"el-icon-warning-outline"}),f(" 警告：删除操作不可撤销，此食谱将永久删除 ")],-1))])])}}},X=D(J,[["__scopeId","data-v-8cc86874"]]);export{X as default};
