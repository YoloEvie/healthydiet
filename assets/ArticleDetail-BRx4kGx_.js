import{d as ve,r as n,c as Q,v as fe,e as u,f as l,x as y,g as i,j as o,l as k,k as g,u as z,O as ye,F as N,A as U,z as _,U as ge,V as he,y as C,H as r,o as a,B as ke,n as we}from"./element-plus-BAXMo5c4.js";import{a as Ce,u as $e,_ as xe}from"./index-bPO5O26h.js";import{a as Le}from"./axios-NIGUFBhG.js";const be={class:"main"},Ve={class:"action-bar"},Ae={key:0,class:"article-photos"},Re={class:"image-placeholder"},Se={class:"article-content"},Te={class:"article-title"},ze={class:"article-summary"},Ne={key:0,id:"recipe"},Ue={key:0,class:"article-ingredients"},Be={key:1,class:"article-steps"},De={class:"step-content"},Ie={key:2,class:"article-tips"},je={key:1,id:"simple"},Me=["innerHTML"],Ee={class:"interaction-area"},He={class:"like-section"},Oe={class:"comment-section"},Pe={class:"comment-item"},Ze={class:"comment-author"},qe={class:"comment-content"},Fe={class:"option-eare"},Je={class:"comment-time"},Ge={class:"answer-btn"},Ke={key:0,class:"reply-input-container"},Qe={class:"reply-buttons"},We={key:1,class:"no-comments"},Xe=ve({__name:"ArticleDetail",setup(Ye){const B=Ce(),$=$e(),v=n(B.params.id);n(B.query.recipeId),n(B.query.recipeName);const M=n(""),E=n(""),D=n(""),w=n({ingredients:[],steps:[],tips:""}),R=n([]),S=n(0),x=n(!1),b=n([]),V=n(""),I=n(""),H=n(!0),L=n({}),j=n({}),A=n(null),h=n(""),O=localStorage.getItem("user_id"),c=O?O.replace(/^["']|["']$/g,""):null,P=Q(()=>I.value?I.value.replace(/<!--[\s\S]*?-->/g,"").replace(/<([a-zA-Z0-9]+)\s+[^>]*?\/?>/g,(e,t)=>e.replace(/\s+[^=\s]+?=(["'])[^"']*?\1/g,f=>/^[a-zA-Z_][a-zA-Z0-9_-]*=/.test(f)?f:"")):"");Q(()=>!0);const p=Le.create({baseURL:"http://localhost:3000/api",timeout:5e3,headers:{"Content-Type":"application/json"}}),Z=n(""),W=e=>{if(!e)return!1;try{return new URL(e),e.match(/\.(jpeg|jpg|gif|png|webp)$/)!==null}catch{return!1}},X=async()=>{try{H.value=!0;const t=(await p.get(`/articles/${v.value}`)).data;Z.value=t.author_id||"",M.value=t.title||"",E.value=t.summary||"",D.value=t.type||"",S.value=t.likes_count||0,t.type==="Recipe"?w.value=t.content?JSON.parse(t.content):{ingredients:[],steps:[],tips:""}:I.value=t.content||"",await Promise.all([Y(),T(),ae()])}catch(e){console.error("获取文章详情失败:",e),r.error("加载文章失败")}finally{H.value=!1}},Y=async()=>{try{const e=await p.get(`/article-photos/article/${v.value}`);R.value=e.data||[]}catch(e){console.error("获取文章照片失败:",e),r.error("加载图片失败")}},ee=async e=>{if(!(j.value[e]||L.value[e]))try{j.value[e]=!0;const t=await p.get(`/users/${e}`);t.data&&t.data.username?L.value[e]=t.data.username:L.value[e]=`用户${e.slice(-4)}`}catch(t){console.error(`获取用户${e}信息失败:`,t),L.value[e]=`用户${e.slice(-4)}`}finally{j.value[e]=!1}},te=async()=>{const e=Array.from(new Set(b.value.map(t=>t.user_id)));for(const t of e)await ee(t)},T=async()=>{try{const e=await p.get(`/comments/article/${v.value}`);b.value=e.data||[],await te()}catch(e){console.error("获取评论失败:",e),r.error("加载评论失败")}},se=e=>c?e.user_id===c||Z.value===c:!1,le=async e=>{if(confirm("确定要删除这条评论吗？"))try{await p.delete(`/comments/${e.comment_id||e.id}`),r.success("评论已删除"),await T()}catch(t){console.error("删除评论失败:",t),r.error("删除失败，请重试")}},ae=async()=>{if(c)try{const e=await p.get(`/user-likes/check/${c}/${v.value}`);x.value=e.data.isLiked}catch(e){console.error("检查点赞状态失败:",e)}},ne=async()=>{if(!c){r.warning("请先登录才能点赞"),$.push("/login");return}try{x.value?(await p.delete("/user-likes",{data:{userId:c,articleId:v.value}}),S.value--,x.value=!1,r.success("取消点赞成功")):(await p.post("/user-likes",{userId:c,articleId:v.value}),S.value++,x.value=!0,r.success("点赞成功"))}catch(e){console.error("处理点赞失败:",e),e.response&&e.response.status===401?(r.error("登录状态已过期，请重新登录"),localStorage.removeItem("user_id"),$.push("/login")):r.error("操作失败，请重试")}},re=async()=>{if(!c){r.warning("请先登录才能评论"),$.push("/login");return}if(!V.value.trim()){r.warning("评论内容不能为空");return}try{await p.post("/comments",{content:V.value,user_id:c,article_id:v.value}),r.success("评论成功"),V.value="",await T()}catch(e){console.error("提交评论失败:",e),r.error("评论失败，请重试")}},oe=e=>{if(!c){r.warning("请先登录才能回复"),$.push("/login");return}A.value=e.comment_id||e.id;const t=L.value[e.user_id]||`用户${e.user_id?.slice(-4)}`;h.value=`回复${t}：`,we(()=>{const f=document.getElementById(`reply-input-${A.value}`);if(f){f.focus();const m=h.value.length;f.setSelectionRange(m,m)}})},ie=()=>{A.value=null,h.value=""},ce=async e=>{if(!c){r.warning("请先登录才能回复"),$.push("/login");return}if(!h.value.trim()){r.warning("回复内容不能为空");return}try{await p.post("/comments",{content:h.value,user_id:c,article_id:v.value,parent_id:e.comment_id||e.id}),r.success("回复成功"),A.value=null,h.value="",await T()}catch(t){console.error("提交回复失败:",t),r.error("回复失败，请重试")}},ue=()=>{$.go(-1)},de=e=>e?new Date(e).toLocaleString():"";return fe(()=>{v.value&&X()}),(e,t)=>{const f=g("el-icon"),m=g("el-button"),q=g("el-image"),F=g("el-list-item"),J=g("el-list"),G=g("el-card"),_e=g("el-timeline-item"),pe=g("el-timeline"),K=g("el-input");return a(),u("div",be,[l("div",Ve,[i(m,{type:"success",onClick:ue,style:{"margin-left":"10px"}},{default:o(()=>[i(f,null,{default:o(()=>[i(z(ye))]),_:1}),t[2]||(t[2]=k(" 退出 "))]),_:1,__:[2]})]),R.value.length>0?(a(),u("div",Ae,[(a(!0),u(N,null,U(R.value,(s,d)=>(a(),C(q,{key:s.photo_id||d,src:s.image_url,"preview-src-list":R.value.map(me=>me.image_url),class:"article-photo",fit:"contain"},{placeholder:o(()=>[l("div",Re,[i(f,null,{default:o(()=>[i(z(ke))]),_:1})])]),_:2},1032,["src","preview-src-list"]))),128))])):y("",!0),l("div",Se,[l("h1",Te,_(M.value),1),l("div",ze,[t[3]||(t[3]=l("h2",null,"简介",-1)),l("p",null,_(E.value),1)]),D.value==="Recipe"?(a(),u("div",Ne,[w.value?.ingredients?.length?(a(),u("div",Ue,[t[4]||(t[4]=l("h2",null,"食材准备",-1)),i(J,{class:"ingredient-list"},{default:o(()=>[(a(!0),u(N,null,U(w.value.ingredients,(s,d)=>(a(),C(F,{key:d,class:"ingredient-item"},{default:o(()=>[k(_(s.name)+"："+_(s.amount),1)]),_:2},1024))),128))]),_:1})])):y("",!0),w.value?.steps?.length?(a(),u("div",Be,[t[5]||(t[5]=l("h2",null,"制作步骤",-1)),i(pe,null,{default:o(()=>[(a(!0),u(N,null,U(w.value.steps,(s,d)=>(a(),C(_e,{key:d,timestamp:`步骤 ${d+1}`},{default:o(()=>[i(G,null,{default:o(()=>[l("div",De,_(s.content),1),s.image_url&&W(s.image_url)?(a(),C(q,{key:0,src:s.image_url,style:{width:"100%","margin-top":"10px"},fit:"contain"},null,8,["src"])):y("",!0)]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})])):y("",!0),w.value?.tips?(a(),u("div",Ie,[t[6]||(t[6]=l("h2",null,"小贴士",-1)),i(G,{class:"tips-card"},{default:o(()=>[l("p",null,_(w.value.tips),1)]),_:1})])):y("",!0)])):y("",!0),D.value==="Ordinary"&&P.value?(a(),u("div",je,[l("div",{class:"ordinary-content",innerHTML:P.value},null,8,Me)])):y("",!0),l("div",Ee,[l("div",He,[i(m,{icon:x.value?z(ge):z(he),type:x.value?"danger":"default",onClick:ne,class:"like-button"},{default:o(()=>[k(_(S.value),1)]),_:1},8,["icon","type"])]),l("div",Oe,[l("h2",null,"评论 ("+_(b.value.length)+")",1),i(K,{modelValue:V.value,"onUpdate:modelValue":t[0]||(t[0]=s=>V.value=s),type:"textarea",placeholder:"写下你的评论...",rows:3,class:"comment-input"},null,8,["modelValue"]),i(m,{type:"primary",onClick:re,style:{"margin-top":"10px"}},{default:o(()=>t[7]||(t[7]=[k(" 提交评论 ")])),_:1,__:[7]}),b.value.length>0?(a(),C(J,{key:0,class:"comment-list",border:""},{default:o(()=>[(a(!0),u(N,null,U(b.value,s=>(a(),C(F,{key:s.comment_id||s.id},{default:o(()=>[l("div",Pe,[l("div",Ze,_(L.value[s.user_id]||"加载中..."),1),l("div",qe,_(s.content),1),l("div",Fe,[l("div",Je,_(de(s.created_at)),1),l("div",Ge,[i(m,{size:"small",onClick:d=>oe(s)},{default:o(()=>t[8]||(t[8]=[k(" 回复 ")])),_:2,__:[8]},1032,["onClick"]),se(s)?(a(),C(m,{key:0,type:"success",size:"small",onClick:d=>le(s),style:{"margin-left":"10px"}},{default:o(()=>t[9]||(t[9]=[k(" 删除 ")])),_:2,__:[9]},1032,["onClick"])):y("",!0)])]),A.value===(s.comment_id||s.id)?(a(),u("div",Ke,[i(K,{modelValue:h.value,"onUpdate:modelValue":t[1]||(t[1]=d=>h.value=d),type:"textarea",rows:2,class:"reply-input",id:`reply-input-${s.comment_id||s.id}`},null,8,["modelValue","id"]),l("div",Qe,[i(m,{type:"primary",size:"small",onClick:d=>ce(s)},{default:o(()=>t[10]||(t[10]=[k(" 发送 ")])),_:2,__:[10]},1032,["onClick"]),i(m,{type:"default",size:"small",onClick:ie,style:{"margin-left":"10px"}},{default:o(()=>t[11]||(t[11]=[k(" 取消 ")])),_:1,__:[11]})])])):y("",!0)])]),_:2},1024))),128))]),_:1})):(a(),u("div",We,"暂无评论，快来抢沙发吧~"))])])])])}}}),lt=xe(Xe,[["__scopeId","data-v-df3b90dd"]]);export{lt as default};
